name: Build and Release Shuyu

on:
  push:
    branches: [ master, main ]
    paths-ignore:
      - 'README.md'
      - '**/*.md'
      - '.gitignore'
      - 'LICENSE'

env:
  DOTNET_VERSION: '10.0.x'
  PROJECT_NAME: 'Shuyu'
  SOLUTION_FILE: 'Shuyu.slnx'

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    # ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ã‚¿ã‚°ã¨ã‚³ãƒŸãƒƒãƒˆå±¥æ­´ã®å–å¾—
    
    # .NET 10 SDKã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    - name: Setup .NET 10
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    # NuGetãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®å¾©å…ƒ
    - name: Restore NuGet packages
      run: dotnet restore ${{ env.SOLUTION_FILE }}
    
    # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã®ç”Ÿæˆã¨ãƒ“ãƒ«ãƒ‰æƒ…å ±ã®è¨­å®š
    - name: Generate version and build info
      id: version
      shell: pwsh
      run: |
        # csprojãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†å¸°æ¤œç´¢ã—ã¦æœ€åˆã«è¦‹ã¤ã‹ã£ãŸã‚‚ã®ã‚’ä½¿ã†ï¼ˆè¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
        $csproj = Get-ChildItem -Path . -Filter "*.csproj" -Recurse -File | Select-Object -First 1
        if ($csproj) {
          [xml]$proj = Get-Content $csproj.FullName
          $baseVersion = $proj.Project.PropertyGroup.Version
        } else {
          $baseVersion = $null
        }

        if (-not $baseVersion) {
          $baseVersion = "0.1.0"
        }

        # ãƒ“ãƒ«ãƒ‰ç•ªå·ã‚’è¿½åŠ ï¼ˆä¾‹: 0.1.0 -> 0.1.0.123ï¼‰
        $fullVersion = "$baseVersion.${{ github.run_number }}"

        # çŸ­ç¸®ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ã‚‚ç”Ÿæˆ
        $sha = "${{ github.sha }}"
        $shortSha = if ($sha.Length -ge 7) { $sha.Substring(0, 7) } else { $sha }

        # GitHubç’°å¢ƒå¤‰æ•°ã¨step outputã®ä¸¡æ–¹ã«è¨­å®š (PowerShell ã§å®‰å…¨ã«æ›¸ãè¾¼ã¿)
        "VERSION=$fullVersion" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        "BASE_VERSION=$baseVersion" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        "SHORT_SHA=$shortSha" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        "FULL_VERSION=$fullVersion" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        "SHORT_SHA=$shortSha" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        # csproj ã®ç›¸å¯¾ãƒ‘ã‚¹ã‚’å‡ºåŠ›ï¼ˆpublish ã§ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ãªããƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æŒ‡å®šã™ã‚‹ãŸã‚ï¼‰
        if ($csproj) {
          $rel = [IO.Path]::GetRelativePath((Get-Location).Path, $csproj.FullName)
          "CSPROJ_PATH=$rel" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "CSPROJ_PATH=$rel" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        }

        Write-Host "Generated version: $fullVersion (base: $baseVersion)"
        Write-Host "Short SHA: $shortSha"
    
    # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ“ãƒ«ãƒ‰ï¼ˆReleaseæ§‹æˆï¼‰
    - name: Build solution
      run: |
        dotnet build ${{ env.SOLUTION_FILE }} `
          --configuration Release `
          --no-restore `
          --verbosity minimal `
          -p:Version=${{ steps.version.outputs.VERSION }}
    
    # .NET 10ç”¨ã®è‡ªå·±å®Œçµå‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç™ºè¡Œ
    - name: Publish application (Self-contained)
      run: |
        # runtime å‘ã‘ã«ãƒ“ãƒ«ãƒ‰ã—ã¦ãƒ©ãƒ³ã‚¿ã‚¤ãƒ å›ºæœ‰ã®æˆæœç‰©ã‚’ç”Ÿæˆ
        dotnet build ${{ steps.version.outputs.CSPROJ_PATH }} `
          --configuration Release `
          --no-restore `
          --runtime win-x64 `
          -p:Version=${{ steps.version.outputs.VERSION }}

        dotnet publish ${{ steps.version.outputs.CSPROJ_PATH }} `
          --configuration Release `
          --output ./publish/win-x64 `
          --self-contained true `
          --runtime win-x64 `
          -p:PublishSingleFile=true `
          -p:IncludeNativeLibrariesForSelfExtract=true `
          -p:Version=${{ steps.version.outputs.VERSION }}

    # ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ä¾å­˜ç‰ˆã‚‚ä½œæˆï¼ˆã‚µã‚¤ã‚ºãŒå°ã•ã„ï¼‰
    - name: Publish application (Framework-dependent)
      run: |
        # ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ä¾å­˜ç‰ˆã¯ publish ã«ãƒ“ãƒ«ãƒ‰ã‚’ä»»ã›ã‚‹ï¼ˆ--no-build ã‚’å‰Šé™¤ï¼‰
        dotnet publish ${{ steps.version.outputs.CSPROJ_PATH }} `
          --configuration Release `
          --output ./publish/win-x64-fx `
          --self-contained false `
          --runtime win-x64 `
          -p:PublishSingleFile=true `
          -p:Version=${{ steps.version.outputs.VERSION }}

    # ARM64ç‰ˆã‚‚ä½œæˆï¼ˆè‡ªå·±å®Œçµå‹ï¼‰
    - name: Publish application (ARM64)
      run: |
        dotnet build ${{ steps.version.outputs.CSPROJ_PATH }} `
          --configuration Release `
          --no-restore `
          --runtime win-arm64 `
          -p:Version=${{ steps.version.outputs.VERSION }}

        dotnet publish ${{ steps.version.outputs.CSPROJ_PATH }} `
          --configuration Release `
          --output ./publish/win-arm64 `
          --self-contained true `
          --runtime win-arm64 `
          -p:PublishSingleFile=true `
          -p:IncludeNativeLibrariesForSelfExtract=true `
          -p:Version=${{ steps.version.outputs.VERSION }}
    
    # README.txtãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
    - name: Create README file
      shell: pwsh
      run: |
        $readmeContent = @"
        Shuyu - Screen Capture Application
        ==================================
        
        Version: v${{ steps.version.outputs.VERSION }}
        Build Date: $(Get-Date).ToUniversalTime().ToString('yyyy-MM-dd HH:mm:ss') UTC
        Commit: ${{ steps.version.outputs.SHORT_SHA }}
        
        System Requirements:
        - Windows 10/11
        - .NET 10.0 Runtime (ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ä¾å­˜ç‰ˆã®å ´åˆ)
        
        ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•:
        1. ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä»»æ„ã®ãƒ•ã‚©ãƒ«ãƒ€ã«å±•é–‹
        2. Shuyu.exe ã‚’å®Ÿè¡Œ
        3. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã‚·ã‚¹ãƒ†ãƒ ãƒˆãƒ¬ã‚¤ã«è¡¨ç¤ºã•ã‚Œã¾ã™
        
        ä½¿ç”¨æ–¹æ³•:
        - ã‚·ã‚¹ãƒ†ãƒ ãƒˆãƒ¬ã‚¤ã‚¢ã‚¤ã‚³ãƒ³ã‚’å³ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹
        - Capture: æ–°ã—ã„ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚’é–‹å§‹
        - Settings: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
        - Exit: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’çµ‚äº†
        
        ã‚­ãƒ£ãƒ—ãƒãƒ£ä¸­:
        - ã‚¯ãƒªãƒƒã‚¯&ãƒ‰ãƒ©ãƒƒã‚°ã§ç¯„å›²ã‚’é¸æŠ
        - å³ã‚¯ãƒªãƒƒã‚¯ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        - ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ãŸç”»åƒã¯ä¿å­˜ã•ã‚Œã€å‚ç…§ç”¨ã«ãƒ”ãƒ³ç•™ã‚ã§ãã¾ã™
        
        ã‚µãƒãƒ¼ãƒˆ:
        å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã€GitHubãƒªãƒã‚¸ãƒˆãƒªã§Issueã‚’å ±å‘Šã—ã¦ãã ã•ã„:
        https://github.com/yamahand/Shuyu/issues
        "@
        
        # å„ãƒ•ã‚©ãƒ«ãƒ€ã«READMEã‚’ä½œæˆï¼ˆå­˜åœ¨ãƒã‚§ãƒƒã‚¯ã¨å¼·åˆ¶ä¸Šæ›¸ãï¼‰
        $paths = @("./publish/win-x64","./publish/win-x64-fx","./publish/win-arm64")
        foreach ($p in $paths) {
          if (-not (Test-Path $p)) { New-Item -ItemType Directory -Path $p -Force | Out-Null }
          $readmeContent | Out-File -FilePath (Join-Path $p "README.txt") -Encoding UTF8 -Force
        }
    
    # å„ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å‘ã‘ã®ZIPãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
    - name: Create release archives
      shell: pwsh
      run: |
        $name = "${{ env.PROJECT_NAME }}-v${{ steps.version.outputs.VERSION }}"

        # è‡ªå·±å®Œçµç‰ˆ (x64)
        Compress-Archive -Path "./publish/win-x64/*" -DestinationPath "./${name}-win-x64-standalone.zip" -Force

        # ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ä¾å­˜ç‰ˆ (x64)
        Compress-Archive -Path "./publish/win-x64-fx/*" -DestinationPath "./${name}-win-x64-framework-dependent.zip" -Force

        # ARM64ç‰ˆ
        Compress-Archive -Path "./publish/win-arm64/*" -DestinationPath "./${name}-win-arm64-standalone.zip" -Force
    
    # GitHubãƒªãƒªãƒ¼ã‚¹ã®ä½œæˆã¨æˆæœç‰©ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆæœ€æ–°ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ï¼‰
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: "v${{ steps.version.outputs.VERSION }}"
        name: "Shuyu v${{ steps.version.outputs.VERSION }} (Development)"
        body: |
          ## ğŸš§ Shuyu v${{ steps.version.outputs.VERSION }} (é–‹ç™ºç‰ˆ)
          
          **âš ï¸ æ³¨æ„: ã“ã‚Œã¯é–‹ç™ºç‰ˆãƒªãƒªãƒ¼ã‚¹ã§ã™ã€‚å®‰å®šç‰ˆã§ã¯ãªã„ãŸã‚ã€äºˆæœŸã—ãªã„å‹•ä½œã‚„ãƒã‚°ãŒå«ã¾ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚**
          
          Windowsç”¨ã®è»½é‡ã§åŠ¹ç‡çš„ãªã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
          
          ### âœ¨ ä¸»ãªæ©Ÿèƒ½
          - ç”»é¢ã®é¸æŠç¯„å›²ã‚­ãƒ£ãƒ—ãƒãƒ£
          - ç›´æ„Ÿçš„ãªã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤é¸æŠUI
          - ã‚·ã‚¹ãƒ†ãƒ ãƒˆãƒ¬ã‚¤çµ±åˆ
          - ã‚­ãƒ£ãƒ—ãƒãƒ£ç”»åƒã®ãƒ”ãƒ³ç•™ã‚æ©Ÿèƒ½
          - ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½ãªãƒ›ãƒƒãƒˆã‚­ãƒ¼ã‚µãƒãƒ¼ãƒˆ
          - ãƒãƒ«ãƒãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤å¯¾å¿œ
          - ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°æ©Ÿèƒ½
          
          ### ğŸ“¦ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          
          **Intel/AMD 64bit CPU æ¨å¥¨**: `${{ env.PROJECT_NAME }}-v${{ steps.version.outputs.VERSION }}-win-x64-standalone.zip`
          - .NET RuntimeãŒä¸è¦ï¼ˆè‡ªå·±å®Œçµå‹ï¼‰
          - ã‚µã‚¤ã‚ºã¯å¤§ãã‚ã§ã™ãŒã€ã™ãã«å®Ÿè¡Œå¯èƒ½
          
          **Intel/AMD 64bit CPU è»½é‡ç‰ˆ**: `${{ env.PROJECT_NAME }}-v${{ steps.version.outputs.VERSION }}-win-x64-framework-dependent.zip`
          - åˆ¥é€” .NET 10.0 Runtime ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå¿…è¦
          - ã‚µã‚¤ã‚ºãŒå°ã•ã„
          
          **ARM64 CPU**: `${{ env.PROJECT_NAME }}-v${{ steps.version.outputs.VERSION }}-win-arm64-standalone.zip`
          - ARM64ãƒ—ãƒ­ã‚»ãƒƒã‚µæ­è¼‰ã®Windows PCç”¨ï¼ˆSurface Pro X ãªã©ï¼‰
          - .NET RuntimeãŒä¸è¦ï¼ˆè‡ªå·±å®Œçµå‹ï¼‰
          
          ### ğŸ’» ã‚·ã‚¹ãƒ†ãƒ è¦ä»¶
          - Windows 10/11
          - .NET 9.0 Runtimeï¼ˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ä¾å­˜ç‰ˆã®å ´åˆï¼‰
          
          ### ğŸš€ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          1. CPUã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«é©ã—ãŸZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          2. ä»»æ„ã®ãƒ•ã‚©ãƒ«ãƒ€ã«å±•é–‹
          3. `Shuyu.exe` ã‚’å®Ÿè¡Œ
          
          ### ğŸ“ å¤‰æ›´å±¥æ­´
          
          **ãƒ“ãƒ«ãƒ‰æƒ…å ±**
          - ãƒ™ãƒ¼ã‚¹ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${{ steps.version.outputs.BASE_VERSION }}
          - ãƒ“ãƒ«ãƒ‰ç•ªå·: ${{ github.run_number }}
          - ãƒ“ãƒ«ãƒ‰æ—¥æ™‚: ${{ github.event.head_commit.timestamp }}
          - ã‚³ãƒŸãƒƒãƒˆ: [`${{ steps.version.outputs.SHORT_SHA }}`](https://github.com/yamahand/Shuyu/commit/${{ github.sha }})
          - .NET ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 10.0
          - å¯¾å¿œã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£: x64, ARM64
          
          ---
          
          ğŸ› ãƒã‚°å ±å‘Šã‚„æ©Ÿèƒ½è¦æ±‚ã¯ [Issues](https://github.com/yamahand/Shuyu/issues) ã§ãŠçŸ¥ã‚‰ã›ãã ã•ã„
        files: |
          ${{ env.PROJECT_NAME }}-v${{ steps.version.outputs.VERSION }}-win-x64-standalone.zip
          ${{ env.PROJECT_NAME }}-v${{ steps.version.outputs.VERSION }}-win-x64-framework-dependent.zip
          ${{ env.PROJECT_NAME }}-v${{ steps.version.outputs.VERSION }}-win-arm64-standalone.zip
        prerelease: true
        draft: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}